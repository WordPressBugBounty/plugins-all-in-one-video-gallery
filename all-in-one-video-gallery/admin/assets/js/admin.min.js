!function(e){"use strict";function t(e){var t;if(t)return t.open(),!1;(t=wp.media.frames.file_frame=wp.media({frame:"post",state:"insert",multiple:!1})).on("insert",function(){var a=t.state().get("selection").first().toJSON();if(0==a.url.trim().length)return!1;e(a)}),t.state("embed").on("select",function(){var a=t.state().props.toJSON();if(0==a.url.trim().length)return!1;a.id=0,e(a)}),t.on("open",function(){jQuery("#menu-item-gallery, #menu-item-playlist, #menu-item-video-playlist").hide()}),t.open()}function a(){var t=e("#aiovg-mp4").val();t&&t.trim().length>0&&!/\.m3u8/.test(t.toLowerCase())?(e("#aiovg-field-mp4").removeClass("aiovg-is-bunny-stream"),e("#aiovg-thumbnail-generator").show()):e("#aiovg-thumbnail-generator").hide()}function i(t){t.autocomplete({source:function(t,a){e.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"aiovg_autocomplete_get_videos",security:aiovg_admin.ajax_nonce,term:t.term},success:function(t){a(e.map(t,function(e){return{label:e.post_title,value:e.post_title,data:e}}))}})},autoFocus:!0,minLength:0,select:function(t,a){var i=e(this).closest(".aiovg-widget-field"),o="";0!=a.item.data.ID?(o='<span class="dashicons dashicons-yes-alt"></span> ',o+="<span>"+a.item.data.post_title+"</span> ",o+='<a href="javascript:void(0);" class="aiovg-remove-autocomplete-result">'+aiovg_admin.i18n.remove+"</a>"):(o='<span class="dashicons dashicons-info"></span> ',o+="<span>"+aiovg_admin.i18n.no_video_selected+"</span>"),i.find(".aiovg-widget-input-id").val(a.item.data.ID).trigger("change"),i.find(".aiovg-autocomplete-result").html(o)},open:function(){e(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){e(this).removeClass("ui-corner-top").addClass("ui-corner-all"),e(this).val("")}})}function o(e){var t=document.createElement("input");t.value=e,document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),t.remove(),alert(aiovg_admin.i18n.copied+"\n"+e)}function s(e){return"."===e.charAt(e.length-1)?e.slice(0,-1):e}e.fn.aiovgReplaceClass=function(e,t){return this.removeClass(function(t,a){var i=a.match(e);return i?i.join(" "):""}).addClass(t),this};class n{constructor(){if(this.$uploadButton=e("#aiovg-bunny-stream-upload-button"),0===this.$uploadButton.length)return;this.$root=e("#aiovg-field-mp4"),this.$uploadWrapper=e("#aiovg-field-mp4 .aiovg-media-uploader"),this.$uploadField=e('#aiovg-field-mp4 input[type="file"]'),this.$uploadStatus=e("#aiovg-field-mp4 .aiovg-upload-status"),this.upload=null,this.timeout=null,this.options={},this.initOptions(),this.bindEvents()}initOptions(){this.upload=null,this.timeout&&clearTimeout(this.timeout),this.timeout=null,this.options={status:"",videoId:"",retryCount:0,maxRetries:30,cache:null}}bindEvents(){this.$uploadButton.on("click",e=>{e.preventDefault(),this.$uploadField.click()}),this.$uploadField.on("change",e=>{this.handleUpload(e)}),e("#aiovg-field-mp4").on("click",".aiovg-upload-cancel",e=>{e.preventDefault(),this.cancelUpload(),a()})}handleUpload(t){let a=t.target.files[0];if(!a)return;this.initOptions(),this.$uploadStatus.html('<span class="aiovg-text-success">'+aiovg_admin.i18n.preparing_upload+'</span><span class="aiovg-animate-dots"></span>'),this.$root.addClass("aiovg-is-bunny-stream"),this.$uploadWrapper.addClass("aiovg-uploading"),e("#aiovg-thumbnail-generator").hide();let i=e("#title").val();i&&0!==i.trim().length||(i=a.name);let o={action:"aiovg_create_bunny_stream_video",security:aiovg_admin.ajax_nonce,title:i};e.post(ajaxurl,o,t=>{if(!t.success){this.$uploadField.val(""),this.$uploadStatus.html('<span class="aiovg-text-error">'+t.data.error+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading");return}let o={filetype:a.type,title:i};t.data.collection_id&&(o.collection=t.data.collection_id),this.options.videoId=t.data.video_id,this.upload=new tus.Upload(a,{endpoint:"https://video.bunnycdn.com/tusupload",retryDelays:[0,3e3,5e3,1e4,2e4],headers:{AuthorizationSignature:t.data.token,AuthorizationExpire:t.data.expires,VideoId:t.data.video_id,LibraryId:t.data.library_id},metadata:o,onError:e=>{this.$uploadField.val(""),this.$uploadStatus.html('<span class="aiovg-text-error">'+e+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading")},onProgress:(e,t)=>{if("cancelled"===this.options.status)return;let a=(e/t*100).toFixed(2),i=aiovg_admin.i18n.upload_status.replace("%d",Math.min(99.99,a));this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(i):this.$uploadStatus.html('<span class="aiovg-text-success">'+i+'</span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>")},onSuccess:()=>{if("cancelled"!==this.options.status){if(this.upload=null,this.$uploadField.val(""),this.options.cache={mp4:e("#aiovg-mp4").val(),image:e("#aiovg-image").val(),video_id:e("#aiovg-bunny_stream_video_id").val(),deletable_video_ids:e("#aiovg-deletable_bunny_stream_video_ids").val()},e("#aiovg-mp4").val(t.data.video_url),e("#aiovg-image").val(t.data.thumbnail_url),e("#aiovg-bunny_stream_video_id").val(t.data.video_id),this.options.cache.video_id){let a=this.options.cache.deletable_video_ids?this.options.cache.deletable_video_ids.split(","):[];-1===a.indexOf(this.options.cache.video_id)&&a.push(this.options.cache.video_id),e("#aiovg-deletable_bunny_stream_video_ids").val(a.join(","))}this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(s(aiovg_admin.i18n.upload_processing)+'<span class="aiovg-animate-dots"></span>'):this.$uploadStatus.html('<span class="aiovg-text-success">'+s(aiovg_admin.i18n.upload_processing)+'<span class="aiovg-animate-dots"></span></span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>"),this.checkVideoStatus()}}}),this.upload.start()},"json")}checkVideoStatus(){!this.options.videoId||this.options.retryCount++>=this.options.maxRetries||e.ajax({url:ajaxurl,method:"POST",data:{action:"aiovg_get_bunny_stream_video",security:aiovg_admin.ajax_nonce,video_id:this.options.videoId},success:t=>{if("cancelled"!==this.options.status){if(!t.success){this.resetFieldValues(),this.$uploadStatus.html('<span class="aiovg-text-error">'+t.data.error+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading");return}4==t.data.status?(this.$uploadStatus.html('<span class="aiovg-text-success">'+t.data.message+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading"),e("#aiovg-duration").val(t.data.duration)):(this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(s(t.data.message)+'<span class="aiovg-animate-dots"></span>'):this.$uploadStatus.html('<span class="aiovg-text-success">'+s(t.data.message)+'<span class="aiovg-animate-dots"></span></span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>"),this.timeout=setTimeout(()=>this.checkVideoStatus(),5e3))}}})}cancelUpload(){clearTimeout(this.timeout),this.options.status="cancelled",this.$uploadField.val(""),this.$uploadStatus.html(""),this.resetFieldValues(),this.upload&&"function"==typeof this.upload.abort?this.upload.abort().then(()=>this.deleteVideo()).catch(()=>this.deleteVideo()):this.deleteVideo(),this.$uploadWrapper.removeClass("aiovg-uploading"),this.$root.removeClass("aiovg-is-bunny-stream")}deleteVideo(){if(!this.options.videoId)return;this.upload=null;let t={action:"aiovg_delete_bunny_stream_video",security:aiovg_admin.ajax_nonce,video_id:this.options.videoId};setTimeout(()=>{e.post(ajaxurl,t,null,"json")},500)}resetFieldValues(){this.options.cache&&(e("#aiovg-mp4").val(this.options.cache.mp4),e("#aiovg-image").val(this.options.cache.image),e("#aiovg-bunny_stream_video_id").val(this.options.cache.video_id),e("#aiovg-deletable_bunny_stream_video_ids").val(this.options.cache.deletable_video_ids))}}e(function(){e(".aiovg-metabox-ui").each(function(){!function t(a){let i=e(a);i.find(".aiovg-tab").on("click",function(t){t.preventDefault();let a=e(this),o=a.data("target");i.find(".aiovg-tab").removeClass("aiovg-active"),a.addClass("aiovg-active"),i.find(".aiovg-tab-content").hide(),i.find(o).fadeIn(200)}),i.find(".aiovg-accordion-header").on("click",function(t){t.preventDefault();let a=e(this),i=a.closest(".aiovg-accordion");if(i.data("collapsible")){let o=a.find(".dashicons");i.find(".aiovg-accordion-body").slideToggle(200),a.toggleClass("aiovg-open"),o.toggleClass("dashicons-arrow-down-alt2 dashicons-arrow-up-alt2")}})}(this)}),e(document).on("click",".aiovg-upload-media",function(a){a.preventDefault();var i=e(this);t(function(e){i.closest(".aiovg-media-uploader").find("input[type=text]").val(e.url).trigger("file.uploaded")})}),e.fn.wpColorPicker&&(e(".aiovg-color-picker").wpColorPicker(),e(document).on("widget-added widget-updated",function(t,a){a.find(".aiovg-color-picker").wpColorPicker({change:_.throttle(function(){e(this).trigger("change")},3e3)})})),e.fn.magnificPopup&&e(".aiovg-modal-button").magnificPopup({type:"inline",mainClass:"mfp-fade"}),e(".aiovg-repeatable-ui").each(function(){let t=e(this);if(t.find(".aiovg-button-add").on("click",function(a){a.preventDefault();let i=e(this).data("href"),o=document.querySelector(i);if(null!==o){let s=o.content.cloneNode(!0);t.find("tbody").append(s),t.find("table").show()}}),0===t.find("tr").length&&t.find(".aiovg-button-add").trigger("click"),t.on("click",".aiovg-button-delete",function(a){a.preventDefault(),e(this).closest("tr").remove(),0===t.find("tr").length&&t.find("table").hide()}),e.fn.sortable){let a=t.find("tbody");a.hasClass("ui-sortable")&&a.sortable("destroy"),a.sortable({handle:".aiovg-sort-handle",helper:function(t,a){let i=a.children(),o=a.clone();return o.children().each(function(t){e(this).width(i.eq(t).width())}),o}}).disableSelection()}}),e("#aiovg-shortcode-selector input[type=radio]").on("change",function(){var t=e("#aiovg-shortcode-selector input[type=radio]:checked").val();e(".aiovg-shortcode-form").hide(),e("#aiovg-shortcode-form-"+t).show(),e(".aiovg-shortcode-instructions").hide(),e("#aiovg-shortcode-instructions-"+t).show()}).trigger("change"),e("#aiovg-shortcode-forms .aiovg-shortcode-section-header").on("click",function(){var t=e(this),a=t.parent();a.hasClass("aiovg-active")||t.closest(".aiovg-shortcode-form").find(".aiovg-active").removeClass("aiovg-active").find(".aiovg-shortcode-controls").slideToggle(),a.toggleClass("aiovg-active").find(".aiovg-shortcode-controls").slideToggle()}),e("#aiovg-shortcode-form-video select[name=type]").on("change",function(){var t=e(this).val();e("#aiovg-shortcode-form-video").aiovgReplaceClass(/\aiovg-type-\S+/ig,"aiovg-type-"+t)}),e("#aiovg-shortcode-form-videos select[name=template]").on("change",function(){var t=e(this).val();e("#aiovg-shortcode-form-videos").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}).trigger("change"),e("#aiovg-shortcode-form-categories select[name=template]").on("change",function(){var t=e(this).val();e("#aiovg-shortcode-form-categories").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}).trigger("change"),e("#aiovg-generate-shortcode").on("click",function(t){t.preventDefault();var a=e("#aiovg-shortcode-selector input[type=radio]:checked").val(),i=a,o={};for(var s in e(".aiovg-shortcode-field","#aiovg-shortcode-form-"+a).each(function(){var t=e(this),a=t.attr("type"),i=t.attr("name"),s=t.val(),n=0;void 0!==t.data("default")&&(n=t.data("default")),"checkbox"==a?s=t.is(":checked")?1:0:("category"==i||"tag"==i)&&(s=t.find("input[type=checkbox]:checked").map(function(){return this.value}).get().join(",")),s!=n&&(o[i]=s)}),o)o.hasOwnProperty(s)&&(i+=" "+s+'="'+o[s]+'"');e("#aiovg-shortcode").val("[aiovg_"+i+"]")}),e("#aiovg-issues-check-all").on("change",function(){var t=!!e(this).is(":checked");e("#aiovg-issues .aiovg-issue").prop("checked",t)}),e("#aiovg-issues-form").submit(function(){if(!(e("#aiovg-issues .aiovg-issue:checked").length>0))return alert(aiovg_admin.i18n.no_issues_selected),!1}),e(".aiovg-copy-url").on("click",function(){o(e(this).data("url"))}),e(".aiovg-copy-shortcode").on("click",function(){var t;o('[aiovg_video id="'+parseInt(e(this).data("id"))+'"]')}),e("#aiovg-video-type").on("change",function(t){t.preventDefault();var i=e(this).val();e(".aiovg-toggle-fields").hide(),e(".aiovg-type-"+i).slideDown(),"default"==i?a():e("#aiovg-thumbnail-generator").hide()}),e("#aiovg-add-new-source").on("click",function(t){t.preventDefault();var a=e(this),i=parseInt(e(this).data("limit")),o=e("#aiovg-field-mp4 .aiovg-quality-selector").length,s=o-1;0==s&&e("#aiovg-field-mp4 .aiovg-quality-selector").show();var n=document.querySelector("#aiovg-template-source");if(null!==n){var l=n.content.cloneNode(!0);e(l).find("input[type=radio]").attr("name","quality_levels["+s+"]"),e(l).find("input[type=text]").attr("name","sources["+s+"]"),a.before(l)}o+1>=i&&a.hide()}),e("#aiovg-field-mp4").on("change",".aiovg-quality-selector input[type=radio]",function(){var t=e(this),a=[];e(".aiovg-quality-selector").each(function(){var i=e(this).find("input[type=radio]:checked").val();i&&(a.includes(i)?(t.prop("checked",!1),alert(aiovg_admin.i18n.quality_exists)):a.push(i))})}),e("#aiovg-mp4").on("blur file.uploaded",e=>{a()}),e(document).on("click",".aiovg-upload-track",function(a){a.preventDefault();var i=e(this);t(function(e){i.closest("tr").find(".aiovg-track-src input[type=text]").val(e.url)})}),e("#aiovg-field-access_control select").on("change",function(){2==parseInt(e(this).val())?e("#aiovg-field-restricted_roles").show():e("#aiovg-field-restricted_roles").hide()}),"undefined"!=typeof tus&&"function"==typeof tus.Upload&&new n,e("#aiovg-categories-upload-image").on("click",function(a){a.preventDefault(),t(function(t){e("#aiovg-categories-image-wrapper").html('<img src="'+t.url+'" alt="" />'),e("#aiovg-categories-image").val(t.url),e("#aiovg-categories-image_id").val(t.id),e("#aiovg-categories-upload-image").hide(),e("#aiovg-categories-remove-image").show()})}),e("#aiovg-categories-remove-image").on("click",function(t){t.preventDefault(),e("#aiovg-categories-image-wrapper").html(""),e("#aiovg-categories-image").val(""),e("#aiovg-categories-image_id").val(""),e("#aiovg-categories-remove-image").hide(),e("#aiovg-categories-upload-image").show()}),e(document).ajaxComplete(function(t,a,i){if(e("#aiovg-categories-image").length&&i.data){var o=i.data.split("&");-1!==e.inArray("action=add-tag",o)&&e(a.responseXML).find("term_id").text()&&(e("#aiovg-categories-image-wrapper").html(""),e("#aiovg-categories-image").val(""),e("#aiovg-categories-image_id").val(""),e("#aiovg-categories-remove-image").hide(),e("#aiovg-categories-upload-image").show(),e("#aiovg-categories-exclude_search_form").prop("checked",!1),e("#aiovg-categories-exclude_video_form").prop("checked",!1))}}),e("#aiovg-settings .form-table").each(function(){var t=e(this).find("tr:first th label").attr("for").split("[");t=t[0].replace(/_/g,"-"),e(this).attr("id",t)}),e("#aiovg-player-settings tr.player input[type=radio]").on("change",function(){var t=e("#aiovg-player-settings tr.player input[type=radio]:checked").val();e("#aiovg-player-settings").aiovgReplaceClass(/\aiovg-player-\S+/ig,"aiovg-player-"+t)}).trigger("change"),e("#aiovg-categories-settings tr.template select").on("change",function(){var t=e(this).val();e("#aiovg-categories-settings").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}).trigger("change"),e("#aiovg-videos-settings tr.template select").on("change",function(){var t=e(this).val();e("#aiovg-videos-settings").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}).trigger("change"),e('#aiovg-bunny-stream-settings tr.enable_token_authentication input[type="checkbox"]').on("change",function(){var t=e(this).is(":checked")?"enabled":"disabled";e("#aiovg-bunny-stream-settings").aiovgReplaceClass(/\aiovg-token-authentication-\S+/ig,"aiovg-token-authentication-"+t)}).trigger("change"),e("#aiovg-restrictions-settings tr.access_control select").on("change",function(){2==parseInt(e(this).val())?e("#aiovg-restrictions-settings tr.restricted_roles").show():e("#aiovg-restrictions-settings tr.restricted_roles").hide()}).trigger("change"),e(document).on("change",".aiovg-widget-form-categories .aiovg-widget-input-template",function(){var t=e(this).val();e(this).closest(".aiovg-widget-form-categories").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}),e(document).on("change",".aiovg-widget-form-videos .aiovg-widget-input-template",function(){var t=e(this).val();e(this).closest(".aiovg-widget-form-videos").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+t)}),e.fn.autocomplete&&(e(".aiovg-autocomplete-input").each(function(){i(e(this))}),e(document).on("widget-added widget-updated",function(e,t){var a=t.find(".aiovg-autocomplete-input");a.length>0&&i(a)}),e(document).on("click",".aiovg-remove-autocomplete-result",function(){var t=e(this).closest(".aiovg-widget-field"),a='<span class="dashicons dashicons-info"></span> ';a+="<span>"+aiovg_admin.i18n.no_video_selected+"</span>",t.find(".aiovg-widget-input-id").val(0).trigger("change"),t.find(".aiovg-autocomplete-result").html(a)}))})}(jQuery);