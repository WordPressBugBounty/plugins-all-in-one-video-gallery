!function(e){"use strict";function a(e){var a;if(a)return a.open(),!1;(a=wp.media.frames.file_frame=wp.media({frame:"post",state:"insert",multiple:!1})).on("insert",function(){var t=a.state().get("selection").first().toJSON();if(0==t.url.trim().length)return!1;e(t)}),a.state("embed").on("select",function(){var t=a.state().props.toJSON();if(0==t.url.trim().length)return!1;t.id=0,e(t)}),a.on("open",function(){jQuery("#menu-item-gallery, #menu-item-playlist, #menu-item-video-playlist").hide()}),a.open()}function t(){var a=e("#aiovg-mp4").val();a&&a.trim().length>0&&!/\.m3u8/.test(a.toLowerCase())?(e("#aiovg-field-mp4").removeClass("aiovg-is-bunny-stream"),e("#aiovg-thumbnail-generator").show()):e("#aiovg-thumbnail-generator").hide()}function i(a){a.autocomplete({source:function(a,t){e.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"aiovg_autocomplete_get_videos",security:aiovg_admin.ajax_nonce,term:a.term},success:function(a){t(e.map(a,function(e){return{label:e.post_title,value:e.post_title,data:e}}))}})},autoFocus:!0,minLength:0,select:function(a,t){var i=e(this).closest(".aiovg-widget-field"),o="";0!=t.item.data.ID?(o='<span class="dashicons dashicons-yes-alt"></span> ',o+="<span>"+t.item.data.post_title+"</span> ",o+='<a href="javascript:void(0);" class="aiovg-remove-autocomplete-result">'+aiovg_admin.i18n.remove+"</a>"):(o='<span class="dashicons dashicons-info"></span> ',o+="<span>"+aiovg_admin.i18n.no_video_selected+"</span>"),i.find(".aiovg-widget-input-id").val(t.item.data.ID).trigger("change"),i.find(".aiovg-autocomplete-result").html(o)},open:function(){e(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){e(this).removeClass("ui-corner-top").addClass("ui-corner-all"),e(this).val("")}})}function o(e){var a=document.createElement("input");a.value=e,document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),a.remove(),alert(aiovg_admin.i18n.copied+"\n"+e)}function s(e){return"."===e.charAt(e.length-1)?e.slice(0,-1):e}e.fn.aiovgReplaceClass=function(e,a){return this.removeClass(function(a,t){var i=t.match(e);return i?i.join(" "):""}).addClass(a),this};class n{constructor(){if(this.$uploadButton=e("#aiovg-bunny-stream-upload-button"),0===this.$uploadButton.length)return;this.$root=e("#aiovg-field-mp4"),this.$uploadWrapper=e("#aiovg-field-mp4 .aiovg-media-uploader"),this.$uploadField=e('#aiovg-field-mp4 input[type="file"]'),this.$uploadStatus=e("#aiovg-field-mp4 .aiovg-upload-status"),this.upload=null,this.timeout=null,this.options={},this.initOptions(),this.bindEvents()}initOptions(){this.upload=null,this.timeout&&clearTimeout(this.timeout),this.timeout=null,this.options={status:"",videoId:"",retryCount:0,maxRetries:30,cache:null}}bindEvents(){this.$uploadButton.on("click",e=>{e.preventDefault(),this.$uploadField.click()}),this.$uploadField.on("change",e=>{this.handleUpload(e)}),e("#aiovg-field-mp4").on("click",".aiovg-upload-cancel",e=>{e.preventDefault(),this.cancelUpload(),t()})}handleUpload(a){let t=a.target.files[0];if(!t)return;this.initOptions(),this.$uploadStatus.html('<span class="aiovg-text-success">'+aiovg_admin.i18n.preparing_upload+'</span><span class="aiovg-animate-dots"></span>'),this.$root.addClass("aiovg-is-bunny-stream"),this.$uploadWrapper.addClass("aiovg-uploading"),e("#aiovg-thumbnail-generator").hide();let i=e("#title").val();i&&0!==i.trim().length||(i=t.name);let o={action:"aiovg_create_bunny_stream_video",security:aiovg_admin.ajax_nonce,title:i};e.post(ajaxurl,o,a=>{if(!a.success){this.$uploadField.val(""),this.$uploadStatus.html('<span class="aiovg-text-error">'+a.data.error+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading");return}let o={filetype:t.type,title:i};a.data.collection_id&&(o.collection=a.data.collection_id),this.options.videoId=a.data.video_id,this.upload=new tus.Upload(t,{endpoint:"https://video.bunnycdn.com/tusupload",retryDelays:[0,3e3,5e3,1e4,2e4],headers:{AuthorizationSignature:a.data.token,AuthorizationExpire:a.data.expires,VideoId:a.data.video_id,LibraryId:a.data.library_id},metadata:o,onError:e=>{this.$uploadField.val(""),this.$uploadStatus.html('<span class="aiovg-text-error">'+e+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading")},onProgress:(e,a)=>{if("cancelled"===this.options.status)return;let t=(e/a*100).toFixed(2),i=aiovg_admin.i18n.upload_status.replace("%d",Math.min(99.99,t));this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(i):this.$uploadStatus.html('<span class="aiovg-text-success">'+i+'</span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>")},onSuccess:()=>{if("cancelled"!==this.options.status){if(this.upload=null,this.$uploadField.val(""),this.options.cache={mp4:e("#aiovg-mp4").val(),image:e("#aiovg-image").val(),video_id:e("#aiovg-bunny_stream_video_id").val(),deletable_video_ids:e("#aiovg-deletable_bunny_stream_video_ids").val()},e("#aiovg-mp4").val(a.data.video_url),e("#aiovg-image").val(a.data.thumbnail_url),e("#aiovg-bunny_stream_video_id").val(a.data.video_id),this.options.cache.video_id){let t=this.options.cache.deletable_video_ids?this.options.cache.deletable_video_ids.split(","):[];-1===t.indexOf(this.options.cache.video_id)&&t.push(this.options.cache.video_id),e("#aiovg-deletable_bunny_stream_video_ids").val(t.join(","))}this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(s(aiovg_admin.i18n.upload_processing)+'<span class="aiovg-animate-dots"></span>'):this.$uploadStatus.html('<span class="aiovg-text-success">'+s(aiovg_admin.i18n.upload_processing)+'<span class="aiovg-animate-dots"></span></span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>"),this.checkVideoStatus()}}}),this.upload.start()},"json")}checkVideoStatus(){!this.options.videoId||this.options.retryCount++>=this.options.maxRetries||e.ajax({url:ajaxurl,method:"POST",data:{action:"aiovg_get_bunny_stream_video",security:aiovg_admin.ajax_nonce,video_id:this.options.videoId},success:a=>{if("cancelled"!==this.options.status){if(!a.success){this.resetFieldValues(),this.$uploadStatus.html('<span class="aiovg-text-error">'+a.data.error+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading");return}4==a.data.status?(this.$uploadStatus.html('<span class="aiovg-text-success">'+a.data.message+"</span>"),this.$uploadWrapper.removeClass("aiovg-uploading"),e("#aiovg-duration").val(a.data.duration)):(this.$uploadStatus.find(".aiovg-upload-cancel").length>0?this.$uploadStatus.find(".aiovg-text-success").html(s(a.data.message)+'<span class="aiovg-animate-dots"></span>'):this.$uploadStatus.html('<span class="aiovg-text-success">'+s(a.data.message)+'<span class="aiovg-animate-dots"></span></span> <a class="aiovg-upload-cancel" href="javascript: void(0);">'+aiovg_admin.i18n.cancel_upload+"</a>"),this.timeout=setTimeout(()=>this.checkVideoStatus(),5e3))}}})}cancelUpload(){clearTimeout(this.timeout),this.options.status="cancelled",this.$uploadField.val(""),this.$uploadStatus.html(""),this.resetFieldValues(),this.upload&&"function"==typeof this.upload.abort?this.upload.abort().then(()=>this.deleteVideo()).catch(()=>this.deleteVideo()):this.deleteVideo(),this.$uploadWrapper.removeClass("aiovg-uploading"),this.$root.removeClass("aiovg-is-bunny-stream")}deleteVideo(){if(!this.options.videoId)return;this.upload=null;let a={action:"aiovg_delete_bunny_stream_video",security:aiovg_admin.ajax_nonce,video_id:this.options.videoId};setTimeout(()=>{e.post(ajaxurl,a,null,"json")},500)}resetFieldValues(){this.options.cache&&(e("#aiovg-mp4").val(this.options.cache.mp4),e("#aiovg-image").val(this.options.cache.image),e("#aiovg-bunny_stream_video_id").val(this.options.cache.video_id),e("#aiovg-deletable_bunny_stream_video_ids").val(this.options.cache.deletable_video_ids))}}e(function(){var s,l;e(".aiovg-metabox-ui").each(function(){!function a(t){let i=e(t);i.find(".aiovg-tab").on("click",function(a){a.preventDefault();let t=e(this),o=t.data("target");i.find(".aiovg-tab").removeClass("aiovg-active"),t.addClass("aiovg-active"),i.find(".aiovg-tab-content").hide(),i.find(o).fadeIn(200)}),i.find(".aiovg-accordion-header").on("click",function(a){a.preventDefault();let t=e(this),i=t.closest(".aiovg-accordion");if(i.data("collapsible")){let o=t.find(".dashicons");i.find(".aiovg-accordion-body").slideToggle(200),t.toggleClass("aiovg-open"),o.toggleClass("dashicons-arrow-down-alt2 dashicons-arrow-up-alt2")}})}(this)}),e(document).on("click",".aiovg-upload-media",function(t){t.preventDefault();var i=e(this);a(function(e){i.closest(".aiovg-media-uploader").find("input[type=text]").val(e.url).trigger("file.uploaded")})}),e.fn.wpColorPicker&&(e(".aiovg-color-picker").wpColorPicker(),e(document).on("widget-added widget-updated",function(a,t){t.find(".aiovg-color-picker").wpColorPicker({change:_.throttle(function(){e(this).trigger("change")},3e3)})})),e.fn.magnificPopup&&e(".aiovg-modal-button").magnificPopup({type:"inline",mainClass:"mfp-fade"}),e("#aiovg-shortcode-selector input[type=radio]").on("change",function(){var a=e("#aiovg-shortcode-selector input[type=radio]:checked").val();e(".aiovg-shortcode-form").hide(),e("#aiovg-shortcode-form-"+a).show(),e(".aiovg-shortcode-instructions").hide(),e("#aiovg-shortcode-instructions-"+a).show()}).trigger("change"),e("#aiovg-shortcode-forms .aiovg-shortcode-section-header").on("click",function(){var a=e(this),t=a.parent();t.hasClass("aiovg-active")||a.closest(".aiovg-shortcode-form").find(".aiovg-active").removeClass("aiovg-active").find(".aiovg-shortcode-controls").slideToggle(),t.toggleClass("aiovg-active").find(".aiovg-shortcode-controls").slideToggle()}),e("#aiovg-shortcode-form-video select[name=type]").on("change",function(){var a=e(this).val();e("#aiovg-shortcode-form-video").aiovgReplaceClass(/\aiovg-type-\S+/ig,"aiovg-type-"+a)}),e("#aiovg-shortcode-form-videos select[name=template]").on("change",function(){var a=e(this).val();e("#aiovg-shortcode-form-videos").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}).trigger("change"),e("#aiovg-shortcode-form-categories select[name=template]").on("change",function(){var a=e(this).val();e("#aiovg-shortcode-form-categories").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}).trigger("change"),e("#aiovg-generate-shortcode").on("click",function(a){a.preventDefault();var t=e("#aiovg-shortcode-selector input[type=radio]:checked").val(),i=t,o={};for(var s in e(".aiovg-shortcode-field","#aiovg-shortcode-form-"+t).each(function(){var a=e(this),t=a.attr("type"),i=a.attr("name"),s=a.val(),n=0;void 0!==a.data("default")&&(n=a.data("default")),"checkbox"==t?s=a.is(":checked")?1:0:("category"==i||"tag"==i)&&(s=a.find("input[type=checkbox]:checked").map(function(){return this.value}).get().join(",")),s!=n&&(o[i]=s)}),o)o.hasOwnProperty(s)&&(i+=" "+s+'="'+o[s]+'"');e("#aiovg-shortcode").val("[aiovg_"+i+"]")}),e("#aiovg-issues-check-all").on("change",function(){var a=!!e(this).is(":checked");e("#aiovg-issues .aiovg-issue").prop("checked",a)}),e("#aiovg-issues-form").submit(function(){if(!(e("#aiovg-issues .aiovg-issue:checked").length>0))return alert(aiovg_admin.i18n.no_issues_selected),!1}),e(".aiovg-copy-url").on("click",function(){o(e(this).data("url"))}),e(".aiovg-copy-shortcode").on("click",function(){var a;o('[aiovg_video id="'+parseInt(e(this).data("id"))+'"]')}),e("#aiovg-video-type").on("change",function(a){a.preventDefault();var i=e(this).val();e(".aiovg-toggle-fields").hide(),e(".aiovg-type-"+i).slideDown(),"default"==i?t():e("#aiovg-thumbnail-generator").hide()}).trigger("change"),e("#aiovg-add-new-source").on("click",function(a){a.preventDefault();var t=e(this),i=parseInt(e(this).data("limit")),o=e("#aiovg-field-mp4 .aiovg-quality-selector").length,s=o-1;0==s&&e("#aiovg-field-mp4 .aiovg-quality-selector").show();var n=document.querySelector("#aiovg-template-source");if(null!==n){var l=n.content.cloneNode(!0);l.querySelector("input[type=radio]").setAttribute("name","quality_levels["+s+"]"),l.querySelector("input[type=text]").setAttribute("name","sources["+s+"]"),t.before(l)}o+1>=i&&t.hide()}),e("#aiovg-field-mp4").on("change",".aiovg-quality-selector input[type=radio]",function(){var a=e(this),t=[];e(".aiovg-quality-selector").each(function(){var i=e(this).find("input[type=radio]:checked").val();i&&(t.includes(i)?(a.prop("checked",!1),alert(aiovg_admin.i18n.quality_exists)):t.push(i))})}),e("#aiovg-mp4").on("blur file.uploaded",e=>{t()}),e("#aiovg-add-new-track").on("click",function(a){a.preventDefault();var t=document.querySelector("#aiovg-template-track");if(null!==t){var i=t.content.cloneNode(!0);e("#aiovg-tracks tbody").append(i)}}),0==e("#aiovg-tracks .aiovg-tracks-row").length&&e("#aiovg-add-new-track").trigger("click"),e(document).on("click",".aiovg-upload-track",function(t){t.preventDefault();var i=e(this);a(function(e){i.closest("tr").find(".aiovg-track-src input[type=text]").val(e.url)})}),e(document).on("click",".aiovg-delete-track",function(a){a.preventDefault(),e(this).closest("tr").remove()}),e.fn.sortable&&((s=e("#aiovg-tracks tbody")).hasClass("ui-sortable")&&s.sortable("destroy"),s.sortable({handle:".aiovg-handle"})),e("#aiovg-add-new-chapter").on("click",function(a){a.preventDefault();var t=document.querySelector("#aiovg-template-chapter");if(null!==t){var i=t.content.cloneNode(!0);e("#aiovg-chapters tbody").append(i)}}),0==e("#aiovg-chapters .aiovg-chapters-row").length&&e("#aiovg-add-new-chapter").trigger("click"),e(document).on("click",".aiovg-delete-chapter",function(a){a.preventDefault(),e(this).closest("tr").remove()}),e.fn.sortable&&((l=e("#aiovg-chapters tbody")).hasClass("ui-sortable")&&l.sortable("destroy"),l.sortable({handle:".aiovg-handle"})),e("#aiovg-field-access_control select").on("change",function(){2==parseInt(e(this).val())?e("#aiovg-field-restricted_roles").show():e("#aiovg-field-restricted_roles").hide()}),"undefined"!=typeof tus&&"function"==typeof tus.Upload&&new n,e("#aiovg-categories-upload-image").on("click",function(t){t.preventDefault(),a(function(a){e("#aiovg-categories-image-wrapper").html('<img src="'+a.url+'" alt="" />'),e("#aiovg-categories-image").val(a.url),e("#aiovg-categories-image_id").val(a.id),e("#aiovg-categories-upload-image").hide(),e("#aiovg-categories-remove-image").show()})}),e("#aiovg-categories-remove-image").on("click",function(a){a.preventDefault(),e("#aiovg-categories-image-wrapper").html(""),e("#aiovg-categories-image").val(""),e("#aiovg-categories-image_id").val(""),e("#aiovg-categories-remove-image").hide(),e("#aiovg-categories-upload-image").show()}),e(document).ajaxComplete(function(a,t,i){if(e("#aiovg-categories-image").length&&i.data){var o=i.data.split("&");-1!==e.inArray("action=add-tag",o)&&e(t.responseXML).find("term_id").text()&&(e("#aiovg-categories-image-wrapper").html(""),e("#aiovg-categories-image").val(""),e("#aiovg-categories-image_id").val(""),e("#aiovg-categories-remove-image").hide(),e("#aiovg-categories-upload-image").show(),e("#aiovg-categories-exclude_search_form").prop("checked",!1),e("#aiovg-categories-exclude_video_form").prop("checked",!1))}}),e("#aiovg-settings .form-table").each(function(){var a=e(this).find("tr:first th label").attr("for").split("[");a=a[0].replace(/_/g,"-"),e(this).attr("id",a)}),e("#aiovg-player-settings tr.player input[type=radio]").on("change",function(){var a=e("#aiovg-player-settings tr.player input[type=radio]:checked").val();e("#aiovg-player-settings").aiovgReplaceClass(/\aiovg-player-\S+/ig,"aiovg-player-"+a)}).trigger("change"),e("#aiovg-categories-settings tr.template select").on("change",function(){var a=e(this).val();e("#aiovg-categories-settings").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}).trigger("change"),e("#aiovg-videos-settings tr.template select").on("change",function(){var a=e(this).val();e("#aiovg-videos-settings").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}).trigger("change"),e('#aiovg-bunny-stream-settings tr.enable_token_authentication input[type="checkbox"]').on("change",function(){var a=e(this).is(":checked")?"enabled":"disabled";e("#aiovg-bunny-stream-settings").aiovgReplaceClass(/\aiovg-token-authentication-\S+/ig,"aiovg-token-authentication-"+a)}).trigger("change"),e("#aiovg-restrictions-settings tr.access_control select").on("change",function(){2==parseInt(e(this).val())?e("#aiovg-restrictions-settings tr.restricted_roles").show():e("#aiovg-restrictions-settings tr.restricted_roles").hide()}).trigger("change"),e(document).on("change",".aiovg-widget-form-categories .aiovg-widget-input-template",function(){var a=e(this).val();e(this).closest(".aiovg-widget-form-categories").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}),e(document).on("change",".aiovg-widget-form-videos .aiovg-widget-input-template",function(){var a=e(this).val();e(this).closest(".aiovg-widget-form-videos").aiovgReplaceClass(/\aiovg-template-\S+/ig,"aiovg-template-"+a)}),e.fn.autocomplete&&(e(".aiovg-autocomplete-input").each(function(){i(e(this))}),e(document).on("widget-added widget-updated",function(e,a){var t=a.find(".aiovg-autocomplete-input");t.length>0&&i(t)}),e(document).on("click",".aiovg-remove-autocomplete-result",function(){var a=e(this).closest(".aiovg-widget-field"),t='<span class="dashicons dashicons-info"></span> ';t+="<span>"+aiovg_admin.i18n.no_video_selected+"</span>",a.find(".aiovg-widget-input-id").val(0).trigger("change"),a.find(".aiovg-autocomplete-result").html(t)}))})}(jQuery);