!function(s){"use strict";function a(a){let e=!0;return a.find("[required]").each(function(){t(s(this))||(e=!1)}),e}function t(s){let a=!0,t=s.closest(".aiovg-form-control"),e=s.val().trim();return""===e?(t.addClass("aiovg-form-invalid"),a=!1):t.removeClass("aiovg-form-invalid"),a}function e(s){return"."===s.charAt(s.length-1)?s.slice(0,-1):s}s(function(){s("#aiovg-import-export").find("[required]").each(function(){s(this).on("blur keyup",function(){t(s(this))})}),s("#aiovg-field-csv_columns").on("change","select",function(){let a=[];s("#aiovg-field-csv_columns select").each(function(){let t=s(this).val().trim();t&&a.push(t)}),0===a.length?s("#aiovg-field-csv_columns").addClass("aiovg-form-invalid"):s("#aiovg-field-csv_columns").removeClass("aiovg-form-invalid")}),s("#aiovg-csv_file").on("change file.uploaded",function(){let a=s("#aiovg-field-csv_columns"),t=s("#aiovg-button-import-csv"),i=s("#aiovg-import-csv-status");a.find(".aiovg-form-grid").html(""),a.hide();let n=s("#aiovg-csv_file").val().trim();if(!n)return;t.prop("disabled",!0),i.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(aiovg_import_export.i18n.fetching_csv_columns)+'</span><span class="aiovg-animate-dots"></span>');let o={action:"aiovg_get_csv_columns",security:aiovg_admin.ajax_nonce,csv_file:n,columns_separator:s("#aiovg-columns_separator").val()};s.post(ajaxurl,o,function(s){if(!s.success){i.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+s.data.error+"</span>"),t.prop("disabled",!1);return}i.html('<span class="dashicons dashicons-info-outline"></span> <span>'+aiovg_import_export.i18n.csv_columns_loaded+"</span>"),t.prop("disabled",!1),a.find(".aiovg-form-grid").html(s.data.html),a.fadeIn(200)},"json")}),s("#aiovg-form-import-folder").on("submit",function(t){t.preventDefault();let i=s(this),n=i.find('button[type="submit"]'),o=i.find(".aiovg-form-status");if(!a(i)){o.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+aiovg_import_export.i18n.fields_required+"</span>"),s("html, body").animate({scrollTop:i.find(".aiovg-form-invalid").first().offset().top-75},300);return}n.prop("disabled",!0),o.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(aiovg_import_export.i18n.preparing_import)+'</span><span class="aiovg-animate-dots"></span>');let l=0,p=[],c=[],r=[],d=i.serializeArray();d.push({name:"action",value:"aiovg_import_folder"}),d.push({name:"security",value:aiovg_admin.ajax_nonce}),d.push({name:"limit",value:20}),d.push({name:"offset",value:l});let f=function(){d=d.map(s=>"offset"===s.name?{name:"offset",value:l}:s),s.post(ajaxurl,d,function(s){if(!s.success){o.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+s.data.error+"</span>"),n.prop("disabled",!1);return}l=parseInt(s.data.offset),p=p.concat(s.data.imported),c=c.concat(s.data.skipped),r=r.concat(s.data.failed);let a=s.data.message;if(a=(a=(a=a.replace("%%imported%%",p.length)).replace("%%skipped%%",c.length)).replace("%%failed%%",r.length),"process"===s.data.step)o.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(a)+'</span><span class="aiovg-animate-dots"></span>'),setTimeout(f,100);else if("done"===s.data.step){let t='<span class="aiovg-text-success"><span class="dashicons dashicons-yes-alt"></span> '+a+"</span>";r.length>0&&(t+='<div class="aiovg-form-fieldset">',t+='<h3 class="aiovg-text-error">'+aiovg_import_export.i18n.import_folder_failed_status_heading+"</h3>",r.forEach(s=>{let a=s.split("/").pop();t+='<a class="aiovg-status-item" href="'+encodeURI(s)+'" target="_blank">'+a+"</a>"}),t+="</div>"),o.html(t),n.prop("disabled",!1)}},"json")};f()}),s("#aiovg-form-import-csv").on("submit",function(t){t.preventDefault();let i=s(this),n=i.find('button[type="submit"]'),o=i.find(".aiovg-form-status");if(!a(i)||!function a(){let t=!0,e=[];s("#aiovg-field-csv_columns select").each(function(){let a=s(this).val().trim();a&&e.push(a)});let i=-1!==e.indexOf("post_title"),n=-1!==e.indexOf("video");return i&&n?s("#aiovg-field-csv_columns").removeClass("aiovg-form-invalid"):(s("#aiovg-field-csv_columns").addClass("aiovg-form-invalid"),t=!1),t}()){o.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+aiovg_import_export.i18n.fields_required+"</span>"),s("html, body").animate({scrollTop:i.find(".aiovg-form-invalid").first().offset().top-75},300);return}n.prop("disabled",!0),o.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(aiovg_import_export.i18n.preparing_import)+'</span><span class="aiovg-animate-dots"></span>');let l=0,p=[],c=[],r=[],d=[],f=[],v=i.serializeArray();v.push({name:"action",value:"aiovg_import_csv"}),v.push({name:"security",value:aiovg_admin.ajax_nonce}),v.push({name:"limit",value:20}),v.push({name:"offset",value:l});let m=function(){v=v.map(s=>"offset"===s.name?{name:"offset",value:l}:s),s.post(ajaxurl,v,function(a){if(!a.success){o.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+a.data.error+"</span>"),n.prop("disabled",!1);return}l=parseInt(a.data.offset),p=p.concat(a.data.imported),c=c.concat(a.data.updated),r=r.concat(a.data.skipped),d=d.concat(a.data.failed),f=f.concat(a.data.errors);let t=a.data.message;if(t=(t=(t=(t=t.replace("%%imported%%",p.length)).replace("%%updated%%",c.length)).replace("%%skipped%%",r.length)).replace("%%failed%%",d.length),"process"===a.data.step)o.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(t)+'</span><span class="aiovg-animate-dots"></span>'),setTimeout(m,100);else if("done"===a.data.step){s("#aiovg-csv_file, #aiovg-zip_file").val("");let i='<span class="aiovg-text-success"><span class="dashicons dashicons-yes-alt"></span> '+t+"</span>";f.length>0&&(i+='<div class="aiovg-form-fieldset">',i+='<h3 class="aiovg-text-error">'+aiovg_import_export.i18n.import_csv_error_status_heading+"</h3>",f.forEach(s=>{i+='<span class="aiovg-status-item">'+s+"</span>"}),i+="</div>"),o.html(i),n.prop("disabled",!1)}},"json")};m()}),s("#aiovg-button-export-csv").on("click",function(a){a.preventDefault();let t=s(this),i=s("#aiovg-export-status");t.prop("disabled",!0),i.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(aiovg_import_export.i18n.preparing_export)+'</span><span class="aiovg-animate-dots"></span>');let n={action:"aiovg_export_csv",security:aiovg_admin.ajax_nonce,offset:0,limit:200,total:0,timestamp:new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),file_name:""},o=function(){s.post(ajaxurl,n,function(s){if(!s.success){i.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+s.data.error+"</span>"),t.prop("disabled",!1);return}n.offset=parseInt(s.data.offset),n.total=parseInt(s.data.total),n.file_name=s.data.file_name,"process"===s.data.step?(i.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(s.data.message)+'</span><span class="aiovg-animate-dots"></span>'),setTimeout(o,100)):"done"===s.data.step&&(i.html('<span class="aiovg-text-success"><span class="dashicons dashicons-yes-alt"></span> '+s.data.message+"</span>"),t.prop("disabled",!1))},"json")};o()}),s("#aiovg-button-export-zip").on("click",function(a){a.preventDefault();let t=s(this),i=s("#aiovg-export-status");t.prop("disabled",!0),i.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(aiovg_import_export.i18n.preparing_export)+'</span><span class="aiovg-animate-dots"></span>');let n=[],o=[],l=0,p={action:"aiovg_export_zip",security:aiovg_admin.ajax_nonce,offset:0,limit:50,total:l,timestamp:new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14)},c=function(){s.post(ajaxurl,p,function(s){if(!s.success){i.html('<span class="aiovg-text-error"><span class="dashicons dashicons-dismiss"></span> '+s.data.error+"</span>"),t.prop("disabled",!1);return}if(Array.isArray(s.data.zip_files)&&s.data.zip_files.forEach(function(s){-1===n.indexOf(s)&&n.push(s)}),o=o.concat(s.data.skipped),l=parseInt(s.data.total),p.offset=parseInt(s.data.offset),p.total=l,"process"===s.data.step)i.html('<span class="spinner"></span> <span class="aiovg-text-success">'+e(s.data.message)+'</span><span class="aiovg-animate-dots"></span>'),setTimeout(c,100);else if("done"===s.data.step){let a=s.data.message;0===n.length&&(a=aiovg_import_export.i18n.export_zip_empty_status);let r='<span class="aiovg-text-success"><span class="dashicons dashicons-yes-alt"></span> '+(a=(a=a.replace("%%skipped%%",o.length)).replace("%%exported%%",l-o.length))+"</span>";n.length>0&&(r+='<div class="aiovg-form-fieldset">',r+="<h3>"+aiovg_import_export.i18n.export_zip_success_status_heading+"</h3>",n.forEach(s=>{let a=s.split("/").pop();r+='<a class="aiovg-status-item" href="'+encodeURI(s)+'" target="_blank">'+a+"</a>"}),r+="</div>"),o.length>0&&(r+='<div class="aiovg-form-fieldset">',r+='<h3 class="aiovg-text-error">'+aiovg_import_export.i18n.export_zip_failed_status_heading+"</h3>",o.forEach(s=>{let a=s.split("/").pop();r+='<a class="aiovg-status-item" href="'+encodeURI(s)+'" target="_blank">'+a+"</a>"}),r+="</div>"),i.html(r),t.prop("disabled",!1)}},"json")};c()})})}(jQuery);